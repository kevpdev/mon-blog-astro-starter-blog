#!/bin/bash

# Claude Context Check Command
# Simple verification of project state vs CLAUDE.md documentation

set -e  # Exit on error

echo "ğŸ” Checking Claude context synchronization..."

# Check if we're in the right directory
if [ ! -f "package.json" ]; then
    echo "âŒ Error: package.json not found. Run this from project root."
    exit 1
fi

# Check if CLAUDE.md exists
if [ ! -f "CLAUDE.md" ]; then
    echo "ğŸš¨ CLAUDE.md not found!"
    echo "ğŸ’¡ Run /sync-context to create it"
    exit 1
fi

echo "ğŸ“Š Project Analysis:"
echo ""

# Project info
PROJECT_NAME=$(grep '"name"' package.json | sed 's/.*"\([^"]*\)".*/\1/' | head -1)
echo "ğŸ“¦ Project: $PROJECT_NAME"

# Count scripts
SCRIPT_COUNT=$(grep -c '":' package.json | head -1 || echo "0")
echo "ğŸ“‹ Scripts: $SCRIPT_COUNT found in package.json"

# Check structure
echo "ğŸ—ï¸  Structure:"
if [ -d "src" ]; then
    echo "  âœ… src/ directory exists"
    
    # Check key directories
    for dir in components layouts pages utils config styles; do
        if [ -d "src/$dir" ]; then
            count=$(find "src/$dir" -name "*.astro" -o -name "*.ts" -o -name "*.js" | wc -l)
            echo "  ğŸ“ src/$dir/ - $count files"
        fi
    done
else
    echo "  âŒ src/ directory missing"
fi

echo ""
echo "ğŸ“„ CLAUDE.md Status:"

# Check if key sections exist in CLAUDE.md
if grep -q "## Commands" CLAUDE.md; then
    echo "  âœ… Commands section exists"
else
    echo "  âš ï¸  Commands section missing"
fi

if grep -q "## Architecture" CLAUDE.md; then
    echo "  âœ… Architecture section exists"
else
    echo "  âš ï¸  Architecture section missing"
fi

if grep -q "### Routing" CLAUDE.md; then
    echo "  âœ… Routing section exists"
else
    echo "  âš ï¸  Routing section missing"
fi

if grep -q "<!-- SECTION MANUELLE" CLAUDE.md; then
    echo "  âœ… Manual sections properly marked"
else
    echo "  âš ï¸  Manual sections not marked"
fi

echo ""

# Quick freshness check
PACKAGE_MODIFIED=$(stat -c %Y package.json 2>/dev/null || stat -f %m package.json 2>/dev/null || echo "0")
CLAUDE_MODIFIED=$(stat -c %Y CLAUDE.md 2>/dev/null || stat -f %m CLAUDE.md 2>/dev/null || echo "0")

if [ "$PACKAGE_MODIFIED" -gt "$CLAUDE_MODIFIED" ]; then
    echo "âš ï¸  package.json is newer than CLAUDE.md"
    echo "ğŸ’¡ Consider running /sync-context to update"
    echo ""
fi

# Check for new components/layouts since last update
NEW_COMPONENTS=0
if [ -d "src/components" ]; then
    while IFS= read -r -d '' file; do
        FILE_MODIFIED=$(stat -c %Y "$file" 2>/dev/null || stat -f %m "$file" 2>/dev/null || echo "0")
        if [ "$FILE_MODIFIED" -gt "$CLAUDE_MODIFIED" ]; then
            if [ $NEW_COMPONENTS -eq 0 ]; then
                echo "ğŸ†• New/modified files since last sync:"
            fi
            echo "  ğŸ“„ $(basename "$file")"
            NEW_COMPONENTS=$((NEW_COMPONENTS + 1))
        fi
    done < <(find src/components -name "*.astro" -print0)
fi

if [ -d "src/layouts" ]; then
    while IFS= read -r -d '' file; do
        FILE_MODIFIED=$(stat -c %Y "$file" 2>/dev/null || stat -f %m "$file" 2>/dev/null || echo "0")
        if [ "$FILE_MODIFIED" -gt "$CLAUDE_MODIFIED" ]; then
            if [ $NEW_COMPONENTS -eq 0 ]; then
                echo "ğŸ†• New/modified files since last sync:"
            fi
            echo "  ğŸ“„ $(basename "$file")"
            NEW_COMPONENTS=$((NEW_COMPONENTS + 1))
        fi
    done < <(find src/layouts -name "*.astro" -print0)
fi

if [ $NEW_COMPONENTS -gt 0 ]; then
    echo "ğŸ’¡ Run /sync-context to update documentation"
    echo ""
fi

# Summary
echo "ğŸ“ˆ Summary:"

# Count documented vs actual commands
DOCUMENTED_COMMANDS=$(grep -c "pnpm " CLAUDE.md || echo "0")
echo "  ğŸ“‹ Commands: $DOCUMENTED_COMMANDS documented vs $SCRIPT_COUNT actual"

# Count documented vs actual layouts
if [ -d "src/layouts" ]; then
    ACTUAL_LAYOUTS=$(find src/layouts -name "*.astro" | wc -l)
    DOCUMENTED_LAYOUTS=$(grep -c "\.astro\` -" CLAUDE.md | head -1 || echo "0")
    echo "  ğŸ—ï¸  Layouts: $DOCUMENTED_LAYOUTS documented vs $ACTUAL_LAYOUTS actual"
fi

# Overall status
if [ "$PACKAGE_MODIFIED" -gt "$CLAUDE_MODIFIED" ] || [ $NEW_COMPONENTS -gt 0 ]; then
    echo ""
    echo "ğŸ”§ Status: NEEDS UPDATE"
    echo "ğŸ’¡ Run /sync-context to refresh documentation"
    exit 1
else
    echo ""
    echo "âœ… Status: UP TO DATE"
    echo "ğŸ¯ CLAUDE.md reflects current project structure"
    exit 0
fi