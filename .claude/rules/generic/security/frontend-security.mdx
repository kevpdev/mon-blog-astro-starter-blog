---
description: Frontend security best practices and guidelines
---

# Frontend Security

## Core Security Principles

### Never Commit Secrets
- Never commit secrets, API keys, or passwords to repository
- Use environment variables for sensitive configuration
- Validate environment variables at startup
- Use different secrets for development, staging, and production

### Input Sanitization
```typescript
// ✅ Always sanitize user inputs
function sanitizeUserInput(input: string): string {
  return input
    .trim()
    .replace(/[<>\"']/g, '') // Remove potentially dangerous characters
    .substring(0, 1000); // Limit length
}

// ✅ Validate and sanitize before processing
function processUserComment(rawComment: string): string {
  const sanitized = sanitizeUserInput(rawComment);

  if (sanitized.length === 0) {
    throw createError('validation', 'Comment cannot be empty');
  }

  return sanitized;
}
```

## HTTPS and Transport Security

### HTTPS Everywhere
```typescript
// ✅ Enforce HTTPS in production
if (import.meta.env.PROD && globalThis.location?.protocol !== 'https:') {
  globalThis.location.replace(`https:${globalThis.location.href.substring(globalThis.location.protocol.length)}`);
}

// ✅ Use secure headers
// astro.config.mjs
export default defineConfig({
  server: {
    headers: {
      'Strict-Transport-Security': 'max-age=31536000; includeSubDomains',
      'X-Content-Type-Options': 'nosniff',
      'X-Frame-Options': 'DENY',
      'X-XSS-Protection': '1; mode=block'
    }
  }
});
```

## Content Security Policy (CSP)

### CSP Configuration
```html
<!-- ✅ Implement strict CSP -->
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  script-src 'self' 'unsafe-inline';
  style-src 'self' 'unsafe-inline';
  img-src 'self' data: https:;
  font-src 'self';
  connect-src 'self';
  frame-ancestors 'none';
  base-uri 'self';
  form-action 'self';
">
```

### Inline Script Security
```astro
---
// ✅ Use nonce for inline scripts when necessary
const nonce = crypto.randomUUID();
---

<script nonce={nonce}>
  // Inline script with nonce
</script>

<!-- ✅ Prefer external scripts -->
<script src="/js/theme-handler.js"></script>
```

## Data Validation

### Client-Side Validation
```typescript
// ✅ Always validate on both client and server
function validateEmail(email: string): boolean {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email) && email.length <= 254;
}

function validateUserInput(input: unknown): string {
  if (typeof input !== 'string') {
    throw createError('validation', 'Input must be a string');
  }

  if (input.length > 1000) {
    throw createError('validation', 'Input too long');
  }

  return input;
}
```

### Form Security
```astro
---
// ✅ Validate form data on submit
const formData = await Astro.request.formData();
const email = validateEmail(formData.get('email')?.toString() ?? '');
const message = validateUserInput(formData.get('message'));
---

<form method="POST" action="/contact">
  <!-- ✅ Use proper input types and validation -->
  <input
    type="email"
    name="email"
    required
    maxlength="254"
    pattern="[^@]+@[^@]+\.[^@]+"
  />

  <textarea
    name="message"
    required
    maxlength="1000"
  ></textarea>

  <!-- ✅ CSRF protection would go here if needed -->
  <button type="submit">Send</button>
</form>
```

## Authentication & Authorization

### Token Handling
```typescript
// ✅ Secure token storage and handling
class TokenManager {
  private static readonly TOKEN_KEY = 'auth_token';

  static setToken(token: string): void {
    // Use httpOnly cookies in production, localStorage for development
    if (import.meta.env.PROD) {
      // Set via secure API call that sets httpOnly cookie
      this.setSecureCookie(token);
    } else {
      globalThis.localStorage?.setItem(this.TOKEN_KEY, token);
    }
  }

  static getToken(): string | null {
    if (import.meta.env.PROD) {
      // Token is in httpOnly cookie, accessible via API
      return null; // Retrieved server-side
    }
    return globalThis.localStorage?.getItem(this.TOKEN_KEY) ?? null;
  }

  static clearToken(): void {
    if (import.meta.env.PROD) {
      this.clearSecureCookie();
    } else {
      globalThis.localStorage?.removeItem(this.TOKEN_KEY);
    }
  }
}
```

### Session Management
```typescript
// ✅ Secure session handling
function validateSession(): boolean {
  const token = TokenManager.getToken();

  if (!token) {
    return false;
  }

  try {
    // Validate token format and expiration
    const payload = parseJWT(token);
    return payload.exp > Date.now() / 1000;
  } catch {
    TokenManager.clearToken();
    return false;
  }
}
```

## Cross-Site Scripting (XSS) Prevention

### Output Encoding
```astro
---
// ✅ Astro automatically escapes content, but be explicit
const userContent = sanitizeUserInput(userInput);
---

<!-- ✅ Safe: Astro escapes by default -->
<p>{userContent}</p>

<!-- ❌ Dangerous: Raw HTML -->
<div set:html={userContent} />

<!-- ✅ Safe: Explicit sanitization -->
<div set:html={sanitizeHTML(userContent)} />
```

### Safe HTML Processing
```typescript
// ✅ Use a proper HTML sanitizer for rich content
import DOMPurify from 'isomorphic-dompurify';

function sanitizeHTML(html: string): string {
  return DOMPurify.sanitize(html, {
    ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'ul', 'ol', 'li'],
    ALLOWED_ATTR: []
  });
}
```

## Environment Security

### Environment Variables
```typescript
// ✅ Validate environment variables
interface EnvConfig {
  NODE_ENV: 'development' | 'production' | 'test';
  API_URL: string;
  SITE_URL: string;
}

function validateEnvConfig(): EnvConfig {
  const config = {
    NODE_ENV: import.meta.env.NODE_ENV,
    API_URL: import.meta.env.API_URL,
    SITE_URL: import.meta.env.SITE_URL
  };

  // Validate required variables
  for (const [key, value] of Object.entries(config)) {
    if (!value) {
      throw new Error(`Missing required environment variable: ${key}`);
    }
  }

  return config as EnvConfig;
}
```

### Secrets Management
```typescript
// ✅ Never expose secrets to client
// .env (server-only)
// API_SECRET=secret123
// DATABASE_URL=postgres://...

// ✅ Client-safe environment variables
// .env
// PUBLIC_API_URL=https://api.example.com
// PUBLIC_SITE_NAME=My Blog

// ✅ Use different prefixes for clarity
const clientConfig = {
  apiUrl: import.meta.env.PUBLIC_API_URL,
  siteName: import.meta.env.PUBLIC_SITE_NAME
};

// ❌ Never expose secrets
// const secretKey = import.meta.env.API_SECRET; // This would be undefined anyway
```

## Dependency Security

### Package Auditing
```bash
# ✅ Regular security audits
pnpm audit
pnpm audit --fix

# ✅ Check for vulnerabilities
pnpm dlx audit-ci --config audit-ci.json
```

### Dependency Management
```json
// package.json
{
  "scripts": {
    "audit": "pnpm audit",
    "audit:fix": "pnpm audit --fix",
    "security:check": "pnpm dlx better-npm-audit audit"
  }
}
```

## Error Handling Security

### Safe Error Messages
```typescript
// ✅ Don't expose system information in errors
function handleUserError(error: unknown): string {
  const appError = handleError(error);

  // Log full error details server-side
  logError(appError, 'User operation');

  // Return safe message to user
  switch (appError.type) {
    case 'validation':
      return appError.message; // Safe to show validation errors

    case 'network':
      return 'Une erreur de connexion est survenue. Veuillez réessayer.';

    case 'system':
      return 'Une erreur technique est survenue. Veuillez contacter le support.';

    default:
      return 'Une erreur inattendue est survenue.';
  }
}
```

## Security Checklist

### Development
- [ ] All user inputs are validated and sanitized
- [ ] No secrets committed to repository
- [ ] Environment variables are validated
- [ ] HTTPS is enforced in production
- [ ] CSP headers are configured

### Authentication
- [ ] Tokens are stored securely (httpOnly cookies in production)
- [ ] Session validation is implemented
- [ ] Token expiration is checked
- [ ] Logout clears all session data

### Data Protection
- [ ] User data is validated before processing
- [ ] Output is properly escaped
- [ ] File uploads are restricted and validated
- [ ] Rate limiting is implemented where needed

### Dependencies
- [ ] Regular security audits are performed
- [ ] Dependencies are kept up to date
- [ ] Only necessary packages are installed
- [ ] Vulnerability scanning is automated

### Error Handling
- [ ] Error messages don't expose system information
- [ ] Errors are logged securely
- [ ] Stack traces are not exposed to users
- [ ] Error handling doesn't leak sensitive data