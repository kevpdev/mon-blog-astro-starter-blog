---
import { getCollection } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Container from '../../../components/ui/Container.astro';
import PostCard from '../../../components/ui/PostCard.astro';
import Hero from '../../../components/ui/Hero.astro';
import Section from '../../../components/ui/Section.astro';
import { getPostsByTag, getAllTags } from '../../../utils/tags';

export async function getStaticPaths() {
  const allTags = await getAllTags();
  
  return allTags.map((tag) => ({
    params: { 
      tag: tag
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '')
    },
    props: { 
      originalTag: tag,
      tagSlug: tag
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '')
    }
  }));
}

const { tag } = Astro.params;
const { originalTag } = Astro.props;

if (!tag || !originalTag) {
  throw new Error('Tag parameter is missing');
}

// Récupérer tous les articles avec ce tag
const posts = await getPostsByTag(originalTag);
const capitalizedTag = originalTag.charAt(0).toUpperCase() + originalTag.slice(1);
---

<BaseLayout
  title={`Articles avec le tag "${capitalizedTag}"`}
  description={`Découvrez tous les articles de blog avec le tag ${capitalizedTag}. ${posts.length} article${posts.length > 1 ? 's' : ''} trouvé${posts.length > 1 ? 's' : ''}.`}
>
  <Hero
    title={`Tag: ${capitalizedTag}`}
    subtitle={`${posts.length} article${posts.length > 1 ? 's' : ''} trouvé${posts.length > 1 ? 's' : ''}`}
    centered={true}
  />

  <Section>
    <Container size="xl">
      {posts.length > 0 ? (
        <div class="content-grid-2 lg:grid-cols-3">
          {posts.map((post) => (
            <PostCard post={post} />
          ))}
        </div>
      ) : (
        <div class="text-center py-12">
          <h2 class="text-2xl font-semibold mb-4 text-[rgb(var(--text-primary))]">
            Aucun article trouvé
          </h2>
          <p class="text-[rgb(var(--text-secondary))] mb-6">
            Il n'y a actuellement aucun article avec le tag "{capitalizedTag}".
          </p>
          <a 
            href="/blog"
            class="inline-flex items-center px-4 py-2 bg-[rgb(var(--brand-primary))] text-[rgb(var(--text-inverse))] rounded-lg hover:bg-[rgb(var(--brand-primary-hover))] transition-colors no-underline"
          >
            ← Retour au blog
          </a>
        </div>
      )}
      
      <div class="mt-12 text-center">
        <a 
          href="/blog"
          class="inline-flex items-center px-4 py-2 bg-[rgb(var(--bg-muted))] text-[rgb(var(--text-primary))] rounded-lg hover:bg-[rgb(var(--brand-primary))] hover:text-[rgb(var(--text-inverse))] transition-colors no-underline"
        >
          ← Retour au blog
        </a>
      </div>
    </Container>
  </Section>
</BaseLayout>